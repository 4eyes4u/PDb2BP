<!DOCTYPE html>
<html lang="en">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Aplikacije u višekorisničkom okruženju | Programiranje Db2 baza podataka</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Aplikacije u višekorisničkom okruženju" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Elektronska knjiga “Programiranje Db2 baza podataka” dostupna besplatno na adresi" />
<meta property="og:description" content="Elektronska knjiga “Programiranje Db2 baza podataka” dostupna besplatno na adresi" />
<link rel="canonical" href="https://theikeofficial.github.io//PDb2BP/poglavlja/5/" />
<meta property="og:url" content="https://theikeofficial.github.io//PDb2BP/poglavlja/5/" />
<meta property="og:site_name" content="Programiranje Db2 baza podataka" />
<script type="application/ld+json">
{"description":"Elektronska knjiga “Programiranje Db2 baza podataka” dostupna besplatno na adresi","@type":"WebPage","url":"https://theikeofficial.github.io//PDb2BP/poglavlja/5/","headline":"Aplikacije u višekorisničkom okruženju","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/PDb2BP/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://theikeofficial.github.io//PDb2BP/feed.xml" title="Programiranje Db2 baza podataka" /></head>
<body><header class="site-header" role="banner"
    style="background-image: url(/PDb2BP/resources/header.png); height: 300px; background-repeat: repeat-x;"><a class="site-title" rel="author" href="/PDb2BP/"
        style="display: flex; position: relative; top: 125px; background-color: white; width: 100%; height: 86px;flex-wrap: wrap; justify-content: center; align-items: center; line-height: 0px; font-size: 36px;">
        
        
        <span style="font-weight: bold;">PROGRAMIRANJE&nbsp;</span>
        
        <span style="font-weight: bold;">DB2&nbsp;</span>
        
        <span style="font-weight: bold;">BAZA&nbsp;</span>
        
        <span style="font-weight: bold;">PODATAKA&nbsp;</span>
        
    </a>
</header><main class="page-content" aria-label="Content">
        <div class="wrapper" style="max-width: calc(1100px - (30px * 2));">
            <article class="post">

  <header class="post-header">
    <h1 class="post-title">5. Aplikacije u višekorisničkom okruženju</h1>
  </header>

  <div class="post-content">
    <p>Ovo poglavlje je posvećeno dizajnu aplikacija koje koriste baze podataka, a za koje se očekuje da će biti izvršavane u višekorisničkom okruženju. Ovo podrazumeva da je potrebno uvesti dodatne mere u slučaju da više aplikacija želi da pristupi nekom objektu u bazi podataka (na primer, određenom redu ili tabeli).</p>

<h2 id="51-aplikacioni-proces-i-konkurentnost">5.1 Aplikacioni proces i konkurentnost</h2>

<p>Svi SQL-aplikativni programi se izvršavaju kao deo <em>aplikacionih procesa</em> ili <em>agenata</em>. Aplikacioni proces podrazumeva izvršavanje jednog ili više programa, i predstavlja jedinicu kojoj SUBP alocira resurse i katance. Različiti aplikacioni procesi mogu da povlače sa sobom izvršavanje različitih programa ili različita izvršavanja istog programa.</p>

<p>U višekorisničkom okruženju, osnovna pretpostavka je da više od jednog aplikacionog procesa može da zahteva pristup istim podacima u isto vreme. U tu svrhu, da bi se obezbedio integritet podataka, potrebno je implementirati i koristiti mehanizam poznat pod nazivom zaključavanje.</p>

<div style="border-left: 7px solid rgb(196, 41, 255); padding-left: 15px; background-color: rgba(192, 192, 192, 0.2);">
    <p><span style="font-weight: bold;">Definicija:</span> <span style="font-style: italic;">Zaključavanje</span> (engl. <span style="font-style: italic;">locking</span>) predstavlja mehanizam zasnovan na katancima koji se koristi za održavanje integriteta podataka pod uslovima višekorisničkog okruženja. </p>
</div>

<p>Korišćenjem zaključavanja se može sprečiti da, na primer, dva aplikaciona procesa izvrše ažuriranje istog reda u isto vreme.</p>

<p>SUBP upravlja katancima da bi onemogućio da nepotvrđene izmene napravljene od strane jednog aplikacionog procesa budu vidljive od bilo kog drugog procesa. U trenutku kada se neki proces završi, tada se svi katanci koje je proces dobio od strane RSUBP, i držao ih, oslobađaju. Ipak, aplikacioni proces može da eksplicitno zahteva da se neki katanac oslobodi ranije. Ovo je omogućeno korišćenjem operacije potvrđivanja izmena, koja oslobađa katance koji su dobijeni tokom jedinice posla i koja, takođe, potvrđuje sve izmene koje su obavljene tokom te jedinice posla.</p>

<div style="border-left: 7px solid rgb(196, 41, 255); padding-left: 15px; background-color: rgba(192, 192, 192, 0.2);">
    <p><span style="font-weight: bold;">Definicija:</span> Direktni pozivi DB2 funkcija i ugnežđeni SQL omogućavaju režim konekcije koji se naziva <span style="font-style: italic;">konkurentne transakcije</span> (engl. <span style="font-style: italic;">concurrent transactions</span>) kojim se omogućavaju višestruke konekcije ka bazama podataka, pri čemu svaka od njih predstavlja nezavisnu transakciju. </p>
</div>

<p>Aplikacija može da ima više konkurentnih konekcija ka istoj bazi podataka.</p>

<h2 id="52-katanci">5.2 Katanci</h2>

<p>Kao što smo rekli, katanci predstavljaju osnovni alat za uspostavljanje mehanizma zaključavanja. Svaki katanac ima odgovarajuće karakteristike:</p>

<ul>
  <li>
    <p><em>Režim</em> (engl. <em>mode</em>) definiše tip pristupa koji je dozvoljen procesu koji drži ključ, kao i tip pristupa koji je dozvoljen konkurentnim procesima. Ponekad se režim katanca naziva i <em>stanje</em> (engl. <em>state</em>) katanca.</p>
  </li>
  <li>
    <p><em>Objekat</em> (engl. <em>database object</em>) definiše resurs nad kojim se primenjuje operacija zaključavanja. Jedini tip objekta koji se može programerski zaključati jeste tabela (za više informacija, videti sekciju <a href="#54-programersko-zaključavanje-tabela">5.4</a>). SUBP ima pravo da postavi katanac na druge objekte u bazi podataka, kao što su: redovi, prostori tabela, blokovi, particije podataka, i dr.</p>
  </li>
  <li>
    <p><em>Trajanje</em> (engl. <em>lock count</em>) definiše dužinu vremena tokom kojeg je katanac bio držan od strane procesa. Trajanje katanca se određuje nivoom izolovanosti pod kojim se naredba pokreće (za više informacija o nivoima izolovanosti, videti sekciju <a href="#53-nivoi-izolovanosti">5.3</a>).</p>
  </li>
</ul>

<p>DB2 sistem nudi podršku za različite režime katanaca. Mi ćemo prikazati samo najosnovnije, poređane rastuće po restrikciji koju obezbeđuju:</p>

<ul>
  <li>
    <p><em>IN</em> (engl. <em>intent none</em>) definiše da vlasnik katanca može da čita sve podatke u tabeli, uključujući i nepotvrđene podatke, ali ne može da ih menja. Druge konkurentne aplikacije mogu da čitaju ili da ažuriraju tabelu. Ne postavljaju se nikakvi katanci na redovima.</p>
  </li>
  <li>
    <p><em>IS</em> (engl. <em>intent share</em>) definiše da vlasnik katanca može da čita proizvoljan podatak u tabeli ako se <em>S</em> katanac može dobiti na redovima ili stranicama od interesa.</p>
  </li>
  <li>
    <p><em>IX</em> (engl. <em>intent exclusive</em>) definiše da vlasnik katanca može da čita ili menja proizvoljni podatak u tabeli ako važe naredna dva uslova:</p>

    <ul>
      <li>
        <p><em>X</em> katanac se može dobiti na redovima ili stranicama koje želimo da menjamo.</p>
      </li>
      <li>
        <p><em>S</em> ili <em>U</em> katanac se može dobiti na redovima koje želimo da čitamo.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><em>SIX</em> (engl. <em>share with intent exclusive</em>) definiše da vlasnik katanca može da čita sve podatke iz tabele i da menja redove ako može da dobije <em>X</em> katanac na tim redovima. Za čitanje se ne dobijaju katanci na redovima. Druge konkurentne aplikacije mogu da čitaju iz tabele. <em>SIX</em> katanac se dobija ako aplikacija ima <em>IX</em> katanac na tabeli i onda se zahteva <em>S</em> katanac ili obratno.</p>
  </li>
  <li>
    <p><em>S</em> (engl. <em>share</em>) definiše da vlasnik katanca moze da čita proizvoljan podatak u tabeli i neće dobiti katance na redovima ili stranicama.</p>
  </li>
  <li>
    <p><em>U</em> (engl. <em>update</em>) definiše da vlasnik katanca može da čita proizvoljan podatak u tabeli i može da menja podatke ako se na tabeli može dobiti <em>X</em> katanac. Pritom se ne dobijaju nikakvi katanci na redovima ili stranicama.</p>
  </li>
  <li>
    <p><em>X</em> (engl. <em>exclusive</em>) definiše da vlasnik katanca može da čita i da menja proizvoljan podatak iz tabele. Pritom se ne dobijaju nikakvi katanci na redovima ili stranicama.</p>
  </li>
  <li>
    <p><em>Z</em> (engl. <em>super exclusive</em>) katanac se zahteva na tabeli u posebnim prilikama, kao što su recimo menjanje strukture tabele ili njeno brisanje. Nijedna druga aplikacija (ni ona sa nivoom izolovanosti “nepotvrđeno čitanje”, videti sekciju <a href="#53-nivoi-izolovanosti">5.3</a>) ne može da čita niti da ažurira podatke u tabeli.</p>
  </li>
</ul>

<p>Očigledno, primenom različitih vrsta katanaca, može doći do sukoba u smislu da li SUBP treba da dodeli katanac nekom aplikacionom procesu kada postoji drugi aplikacioni proces koji već drži katanac nad istim objektom. Samo u slučaju kada su katanci <em>kompatibilni</em> će SUBP dodeliti drugi katanac.</p>

<p>U slučaju da katanci nisu kompatibilni, nije moguće dodeliti traženi katanac aplikacionom procesu. Tada taj proces mora da pređe u stanje čekanja dok proces ne oslobodi nekompatibilni katanac koji drži, kao i dok se svi ostali nekompatibilni katanci ne oslobode. U nekim slučajevima može doći do <em>isteka vremena</em> (engl. <em>timeout</em>) dok zatražilac čeka na katanac. O tome će nešto detaljnije biti reči u nastavku, a za sada ćemo prikazati kompatibilnosti između katanaca u narednoj tabeli. Oznaka <em>N</em> znači da nad resursom nema katanca, odnosno, da aplikacioni proces ne traži katanac.</p>

<p><img src="/PDb2BP/poglavlja/5/Slike/tabela-kompatibilnosti-katanaca.png" alt="&quot;Tabela kompatibilnosti katanaca.&quot;" /></p>

<h3 id="521-konverzija-katanaca">5.2.1 Konverzija katanaca</h3>

<p>Konverzija katanca se ostvaruje u situacijama kada aplikacioni proces pristupa objektu nad kojim već drži katanac, a taj pristup zahteva restriktivniji katanac od onog koji se već drži. Proces nad objektom može da drži najviše jedan katanac u nekom trenutku, ali može da traži različite katance nad istim objektom indirektno kroz izvršavanje naredbi.</p>

<div style="border-left: 7px solid rgb(196, 41, 255); padding-left: 15px; background-color: rgba(192, 192, 192, 0.2);">
    <p><span style="font-weight: bold;">Definicija:</span> Promena režima katanca koji se već drži se naziva <span style="font-style: italic;">konverzija katanca</span> (engl. <span style="font-style: italic;">lock conversion</span>). </p>
</div>

<p>Neki režimi katanaca se primenjuju samo za tabele, neki samo za redove, blokove ili particije podataka. Za redove ili blokove, konverzija se uglavnom izvršava ukoliko se traži katanac <em>X</em>, a već se drži katanac <em>S</em> ili <em>U</em>.</p>

<p>Katanci <em>IX</em> i <em>S</em> imaju specijalan odnos — nijedan od ova dva katanca se smatra restriktivnijim u odnosu na drugi. Ukoliko aplikacioni proces drži jedan od ova dva katanca i zahteva drugi, onda će se izvršiti konverzija u katanac <em>SIX</em>. Sve ostale konverzije se vrše po narednom principu:</p>

<div style="width: 80%; text-align: center; margin: auto; margin-bottom: 15px;">
    Ukoliko je katanac koji se zahteva restriktivniji u odnosu na katanac koji se drži, onda se katanac koji se drži konvertuje u katanac koji se zahteva.
</div>

<p>Naravno, da bi se uspešno izvršila konverzija katanca, nad objektom nad kojim se zahteva novi katanac ne sme postojati neki drugi katanac koji je nekompatibilan sa njim.</p>

<h3 id="522-istek-vremena-i-mrtva-petlja">5.2.2 Istek vremena i mrtva petlja</h3>

<p>Već smo napomenuli da, ukoliko aplikacija zahteva katanac nad objektom koji je nekompatibilan sa katancem koji već postoji nad istim objektom, ona ulazi u fazu čekanja dok se taj katanac ne oslobodi. Neka, na primer, jedna transakcija čeka na katanac koji drži neka korisnička aplikacija. Ukoliko korisnik koji koristi tu aplikaciju napusti aplikaciju bez da dozvoli potvrđivanje izmena, onda se katanac ne oslobađa nad tim objektom i transakcija može da čeka beskonačno dugo.</p>

<p>SUBP ima poseban mehanizam kojim se može sprečiti da aplikacija beskonačno dugo čeka na oslobađanje katanca i koji se naziva <em>detekcija isteka vremena</em> (engl. <em>lock timeout detection</em>). Ovaj mehanizam se oslanja na korišćenje <code class="highlighter-rouge">locktimeout</code> parametra podešavanja baze podataka i predstavlja najduže vreme koje transakcija može da čeka na oslobađanje katanca. Podrazumevana vrednost ovog parametra je <code class="highlighter-rouge">-1</code>, što znači da je detekcija isteka vremena onemogućena. U nastavku ćemo videti kako možemo postaviti vrednost ovog parametra, kao i koje je ponašanje SUBP u slučaju da dođe do isteka vremena, međutim, prvo ćemo diskutovati o situaciji do koje može doći u slučaju da aplikacije mogu da čekaju beskonačno dugo na oslobađanje katanca.</p>

<p>Pretpostavimo da postoje dve aplikacije A i B koje rade konkurentno i da je mehanizam detekcije isteka vremena onemogućen u SUBP. Aplikacija A se sastoji od dve operacije: prva operacija želi da ažurira red 1 u tabeli 1, a druga operacija želi da ažurira red 2 u tabeli 2. Aplikacija B se takođe sastoji od dve operacije: prva operacija želi da ažurira red 2 u tabeli 2, a druga operacija želi da ažurira red 1 u tabeli 1. Pretpostavimo takođe da se operacije dešavaju u (približno) isto vreme. Redosled izvršavanja ovih operacija i dobijanja katanaca je sledeći (što je ilustrovano i na narednoj slici):</p>

<ul>
  <li>U trenutku T1:
    <ul>
      <li>Aplikacija A dobija katanac X nad redom 1 u tabeli 1.</li>
      <li>Aplikacija B dobija katanac X nad redom 2 u tabeli 2.</li>
    </ul>
  </li>
  <li>U trenutku T2:
    <ul>
      <li>Aplikacija A pokušava da dobije katanac X nad redom 2 u tabeli 2. Taj katanac je nekompatibilan sa postojećim katancem X koji drži aplikacija B. Aplikacija A prelazi u stanje čekanja.</li>
      <li>Aplikacija B pokušava da dobije katanac X nad redom 1 u tabeli 1. Taj katanac je nekompatibilan sa postojećim katancem X koji drži aplikacija A. Aplikacija B prelazi u stanje čekanja.</li>
    </ul>
  </li>
  <li>U trenutku TN (N &gt; 2):
    <ul>
      <li>Aplikacija A je u stanju čekanja.</li>
      <li>Aplikacija B je u stanju čekanja.</li>
    </ul>
  </li>
</ul>

<p><img src="/PDb2BP/poglavlja/5/Slike/mrtva-petlja.png" alt="&quot;Ilustracija pojave mrtve petlje prilikom izvršavanja dva aplikaciona procesa.&quot;" /></p>

<p>Očigledno, počevši od trenutka T3, obe aplikacije će čekati jedna na drugu beskonačno dugo i neće se “nikad” završiti. Ova pojava se naziva mrtva petlja.</p>

<div style="border-left: 7px solid rgb(196, 41, 255); padding-left: 15px; background-color: rgba(192, 192, 192, 0.2);">
    <p><span style="font-weight: bold;">Definicija:</span> <span style="font-style: italic;">Mrtva petlja</span> (engl. <span style="font-style: italic;">deadlock</span>) predstavlja pojavu kada dve aplikacije (ili više njih) zaključaju podatak koji je neophodan jedan drugoj, što rezultuje u situaciji da se obe aplikacije blokiraju i nijedna ne može da nastavi sa daljim izvršavanjem. </p>
</div>

<p>Zbog toga što aplikacije neće “volonterski” osloboditi katance koje drže nad podacima, da bi se prevazišla mrtva petlja, mora se pristupiti procesu prepoznavanja mrtve petlje. Mehanizam prepoznavanja mrtve petlje nadgleda informacije o agentima koji čekaju na katance i pokreće se na interval specifikovan kroz parametar <code class="highlighter-rouge">dlchktime</code> podešavanja baze podataka.</p>

<p>Ukoliko mehanizam pronađe mrtvu petlju, onda se nasumično bira jedan od procesa u mrtvoj petlji koji se naziva <em>žrtva</em> (engl. <em>victim process</em>), čije će izmene biti poništene. Aplikacija koja pripada procesu žrtvi se podiže i prosleđuje joj se odgovarajući kod koji je ona dužna da obradi. SUBP automatski poništava nepohranjene izmene od strane odabrane aplikacije. Kada je operacija pohranjivanja završena, katanci koji su pripadali procesu žrtvi se oslobađaju i ostali procesi u mrtvoj petlji mogu da nastave dalje sa radom.</p>

<p>Postoje dve vrste grešaka koje SUBP može prijaviti aplikaciji u slučaju da dođe do isteka vremena, odnosno, ako je aplikacija izabrana za žrtvu prilikom prepoznavanja mrtve petlje:</p>

<ul>
  <li>Greška -911
    <ul>
      <li>Značenje: Tekuća transakcija se poništava usled mrtve petlje ili isteka vremena.</li>
      <li>Uz ovu poruku se prilaže i kod koji preciznije označava razlog zbog kojeg se došlo do greske. Ovih kodova ima više, a mi ćemo prikazati dva najznačajnija:
        <ul>
          <li>2: Transakcija je poništena usled mrtve petlje.</li>
          <li>68: Transakcija je poništena usled isteka vremena za katanac.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Pokretanjem komande <code class="highlighter-rouge">db2 ? sql911</code> u terminalu je moguće dobiti više informacija o grešci.</p>

<ul>
  <li>Greška -913
    <ul>
      <li>Značenje: Došlo je do neuspeha pri izvršavanju distribuirane transakcije zbog mrtve petlje ili isteka vremena.</li>
      <li>I uz ovu poruku se prilaže kod koji preciznije označava razlog zbog kojeg se došlo do greske. Ovih kodova ima više, a mi ćemo prikazati dva najznačajnija:
        <ul>
          <li>2: Grana transakcije je neuspešna usled mrtve petlje.</li>
          <li>68: Grana transakcije je neuspešna usled isteka vremena za katanac.</li>
          <li>80: Naredba je neuspešna usled isteka vremena.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Pokretanjem komande <code class="highlighter-rouge">db2 ? sql913</code> u terminalu je moguće dobiti više informacija o grešci.</p>

<p>Još jedan mogući način da se izborimo sa mrtvom petljom jeste da specifikujemo najduži vremenski period koji aplikacija može da čeka na dobijanje katanca. Specijalni registar <code class="highlighter-rouge">CURRENT LOCK TIMEOUT</code>, koji je tipa <code class="highlighter-rouge">INTEGER</code>, sadrži broj sekundi pre nego što SUBP vrati grešku koja indikuje da katanac ne može biti dodeljen aplikacionom procesu.</p>

<p>Validne vrednosti za ovaj registar su u opsegu <code class="highlighter-rouge">[-1, 32767]</code>. Dodatno, specijalnom registru se može postaviti vrednost <code class="highlighter-rouge">NULL</code>. Vrednost <code class="highlighter-rouge">-1</code> označava da SUBP neće prijavljivati istek vremena, već da aplikacija mora da čeka na zahtevani katanac dok se nekompatibilni katanac ne oslobodi ili dok se ne detektuje mrtva petlja. Vrednost <code class="highlighter-rouge">0</code> označava da aplikacija neće čekati na katanac, već ukoliko ne može da dobije katanac kada ga zatraži, odmah će dobiti grešku. Vrednost <code class="highlighter-rouge">NULL</code> označava da će SUBP koristiti vrednost koja je postavljena u parametru <code class="highlighter-rouge">locktimeout</code> o kojem je bilo reči ranije.</p>

<p>Ukoliko želimo da pročitamo vrednost ovog specijalnog registra, nakon konekcije na bazu podataka potrebno je izvršiti narednu komandu u terminalu:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 values CURRENT LOCK TIMEOUT
</code></pre></div></div>

<p>SQL naredba <code class="highlighter-rouge">SET CURRENT LOCK TIMEOUT</code> služi za promenu vrednosti specijalnog registra <code class="highlighter-rouge">CURRENT LOCK TIMEOUT</code>. Izvršavanje ove naredbe nije pod uticajem kontrole transakcije u programu. Zbog toga, ukoliko ovu naredbu koristimo u našim aplikacijama, dobra je praksa vratiti vrednost na podrazumevanu pre završavanja programa. Sintaksa ove naredbe je data u nastavku:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="p">[</span><span class="k">CURRENT</span><span class="p">]</span> <span class="k">LOCK</span> <span class="n">TIMEOUT</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span>
<span class="p">(</span><span class="n">WAIT</span><span class="o">|</span><span class="k">NOT</span> <span class="n">WAIT</span><span class="o">|</span><span class="k">NULL</span><span class="o">|</span><span class="p">[</span><span class="n">WAIT</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">CELOBROJNA_KONSTANTA</span><span class="o">&gt;|&lt;</span><span class="n">MATI</span><span class="err">Č</span><span class="n">NA_PROMENLJIVA</span><span class="o">&gt;</span><span class="p">)</span>
</code></pre></div></div>

<p>Ovoj naredbi je moguće specifikovati naredne vrednosti:</p>

<ul>
  <li>
    <p>Klauzom <code class="highlighter-rouge">WAIT</code> specifikuje se vrednost <code class="highlighter-rouge">-1</code>, što znači da SUBP mora da čeka dok se katanac ne oslobodi ili se ne detektuje mrtva petlja.</p>
  </li>
  <li>
    <p>Klauzom <code class="highlighter-rouge">NOT WAIT</code> specifikuje se vrednost <code class="highlighter-rouge">0</code>, što znači da SUBP ne čeka na katance koji se ne mogu dodeliti aplikacijama, već odmah prijavljuje grešku.</p>
  </li>
  <li>
    <p>Vrednošću <code class="highlighter-rouge">NULL</code> specifikuje se da vrednost u registru <code class="highlighter-rouge">CURRENT LOCK TIMEOUT</code> nije postavljena, čime se efektivno koristi vrednost parametra <code class="highlighter-rouge">locktimeout</code> podešavanja baze podataka. Vrednost koja se vraća za ovaj specijalni registar se menja pri promeni vrednosti parametra <code class="highlighter-rouge">locktimeout</code>.</p>
  </li>
  <li>
    <p>Klauzom <code class="highlighter-rouge">[WAIT] &lt;CELOBROJNA_KONSTANTA&gt;</code> specifikuje se celobrojna vrednost iz intervala <code class="highlighter-rouge">[-1, 32767]</code>. Ako data vrednost pripada intervalu <code class="highlighter-rouge">[1, 32767]</code>, onda će SUBP čekati toliko sekundi pre nego što aplikaciji prosledi grešku. Vrednosti <code class="highlighter-rouge">-1</code> i <code class="highlighter-rouge">0</code> odgovaraju specifikovanju prethodno opisanih klauza <code class="highlighter-rouge">WAIT</code> i <code class="highlighter-rouge">NO WAIT</code>, redom.</p>
  </li>
  <li>
    <p>Navođenjem <code class="highlighter-rouge">&lt;MATIČNA PROMENLJIVA&gt;</code> specifikuje se celobrojna vrednost iz intervala <code class="highlighter-rouge">[-1, 32767]</code> koja se čita iz vrednosti date matične promenljive. Ako data vrednost pripada intervalu <code class="highlighter-rouge">[1, 32767]</code>, onda će SUBP čekati toliko sekundi pre nego što aplikaciji prosledi grešku. Vrednosti <code class="highlighter-rouge">-1</code> i <code class="highlighter-rouge">0</code> odgovaraju specifikovanju prethodno opisanih klauza <code class="highlighter-rouge">WAIT</code> i <code class="highlighter-rouge">NO WAIT</code>, redom.</p>
  </li>
</ul>

<p>Naredni zadatak ilustruje obradu transakcija u višekorisničkom okruženju korišćenjem znanja iz ovog poglavlja.</p>

<div style="border: 2px solid rgb(196, 41, 255); padding: 5px; background-color: rgba(197, 197, 197, 0.3); margin: 10px 0;">
    <p style="font-weight: bold;">Zadatak 5.1</p>
    Napisati C/SQL program koji za svaki predmet omogućuje korisniku da poveća broj semestra u kome se taj predmet sluša za 1. Nakon svakog ažuriranja, proveriti da li je odgovarajuci red u tabeli izmenjen ponovnim dohvatanjem informacija. Dodatno, svaku obradu evidentirati u tabeli <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">OBRADJENI_PREDMETI</span>.<br />
<br />
Napisati program tako da može da radi u višekorisničkom okruženju. Obrada jednog predmeta predstavlja jednu transakciju. Postaviti istek vremena za zahtevanje katanaca na 10 sekundi.
</div>

<p>Rešenje: Pre početka izvršavanja, kreirati tabelu <code class="highlighter-rouge">OBRADJENI_PREDMETI</code> koja sadrži identifikatore predmeta koji su do sada obrađeni:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">OBRADJENI_PREDMETI</span> <span class="p">(</span>
    <span class="n">ID_PREDMETA</span> <span class="n">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ID_PREDMETA</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">ID_PREDMETA</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">PREDMET</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_1.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">d_id</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">d_sifra</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">d_naziv</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">d_broj_semestara</span><span class="p">,</span> 
      <span class="n">d_bodovi</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Greska %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Definisemo funkciju koja ce vrsiti obradu cekanja
// u slucaju da dodje do problema u visekorisnickom okruzenju.
// Primetimo da je definicija odvojena od deklaracije,
// zato sto se u definiciji ove funkcije koristi kursor `predmeti`.
// Da se definicija nasla ispred `main` funkcije,
// Db2 pretprocesor bi izdao upozorenje da se kursor koristi pre deklaracije.
</span><span class="kt">void</span> <span class="n">obradi_cekanje</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">odgovor_od_korisnika</span><span class="p">;</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="c1">// Postavljanje isteka vremena na 10 sekundi
</span>    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set current lock timeout 10"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">predmeti</span> <span class="n">CURSOR</span> <span class="n">WITH</span> <span class="n">HOLD</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">ID_PREDMETA</span><span class="p">,</span> 
                <span class="n">SIFRA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span> 
                <span class="n">BROJ_SEMESTARA</span><span class="p">,</span> 
                <span class="n">BODOVI</span>
        <span class="n">FROM</span>    <span class="n">PREDMET</span> <span class="n">P</span>
        <span class="n">WHERE</span>   <span class="n">NOT</span> <span class="n">EXISTS</span> <span class="p">(</span>
                    <span class="n">SELECT</span>  <span class="o">*</span> 
                    <span class="n">FROM</span>    <span class="n">OBRADJENI_PREDMETI</span>
                    <span class="n">WHERE</span>   <span class="n">ID_PREDMETA</span> <span class="o">=</span> <span class="n">P</span><span class="p">.</span><span class="n">ID_PREDMETA</span>
                <span class="p">)</span>
        <span class="n">FOR</span>     <span class="n">UPDATE</span> <span class="n">OF</span> <span class="n">BROJ_SEMESTARA</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Declare predmeti"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">predmeti</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Open predmeti"</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="c1">// Naredba FETCH dohvata jedan red iz rezultata upita.
</span>        <span class="c1">// Bilo da li se informacije koriste za citanje ili za eventualnu izmenu,
</span>        <span class="c1">// SUBP mora da dodeli aplikaciji odgovarajuci katanac.
</span>        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">predmeti</span> 
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">d_id</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_sifra</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_naziv</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_broj_semestara</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_bodovi</span><span class="p">;</span>
    
        <span class="c1">// U slucaju da dodela katanca ne uspe, 
</span>        <span class="c1">// SUBP ce prijaviti jednu od gresaka -911 ili -913.
</span>        <span class="c1">// S obzirom da u funkciji `is_error` prekidamo program 
</span>        <span class="c1">// u slucaju da je SQLCODE &lt; 0,
</span>        <span class="c1">// obradu katanca moramo vrsiti uvek pre poziva `is_error` funkcije,
</span>        <span class="c1">// i preskociti trenutnu iteraciju.
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">obradi_cekanje</span><span class="p">();</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Fetch predmeti"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Nema vise predmeta za obradjivanje!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="n">printf</span><span class="p">(</span><span class="s">"Predmet - id = %d sifra = %.5s naziv = %.40s "</span>
            <span class="s">"broj_semestara = %d bodovi = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
            <span class="n">d_id</span><span class="p">,</span> <span class="n">d_sifra</span><span class="p">,</span> <span class="n">d_naziv</span><span class="p">,</span> <span class="n">d_broj_semestara</span><span class="p">,</span> <span class="n">d_bodovi</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Da li se zeli promena semestra "</span>
            <span class="s">"u kome se slusa ovaj predmet? "</span>
            <span class="s">"Odgovoriti sa d ili n.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">"%c"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">odgovor_od_korisnika</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>  <span class="c1">// novi red
</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">odgovor_od_korisnika</span> <span class="o">==</span> <span class="sc">'d'</span> <span class="o">||</span> <span class="n">odgovor_od_korisnika</span> <span class="o">==</span> <span class="sc">'D'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Izvrsavanje naredbe UPDATE uvek trazi katanac za azuriranje podataka...
</span>            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">UPDATE</span>  <span class="n">PREDMET</span>
                <span class="n">SET</span>     <span class="n">BROJ_SEMESTARA</span> <span class="o">=</span> <span class="o">:</span><span class="n">d_broj_semestara</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">WHERE</span>   <span class="n">CURRENT</span> <span class="n">OF</span> <span class="n">predmeti</span><span class="p">;</span>

            <span class="c1">// ... sto znaci da moramo i nakon nje da vrsimo obradu greske za visekorisnicko okruzenje.
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">obradi_cekanje</span><span class="p">();</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">is_error</span><span class="p">(</span><span class="s">"Update"</span><span class="p">);</span>

            <span class="c1">// Slicno kao i FETCH, naredba SELECT INTO zahteva katanac za citanje...
</span>            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">SELECT</span>  <span class="n">BROJ_SEMESTARA</span>
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">d_broj_semestara</span> 
                <span class="n">FROM</span>    <span class="n">PREDMET</span>
                <span class="n">WHERE</span>   <span class="n">ID_PREDMETA</span> <span class="o">=</span> <span class="o">:</span><span class="n">d_id</span><span class="p">;</span>

            <span class="c1">// ... sto znaci da moramo i nakon nje da vrsimo obradu greske za visekorisnicko okruzenje.
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">obradi_cekanje</span><span class="p">();</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">is_error</span><span class="p">(</span><span class="s">"Select into"</span><span class="p">);</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"Semestar u kome se slusa predmet je sada %d</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">d_broj_semestara</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="c1">// Bilo da li korisnik zeli izmenu ili ne,
</span>        <span class="c1">// predmet se smatra za obradjen,
</span>        <span class="c1">// te ga je potrebno evidentirati.
</span>        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span> 
            <span class="n">INTO</span>    <span class="n">OBRADJENI_PREDMETI</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="o">:</span><span class="n">d_id</span><span class="p">);</span>
        
        <span class="c1">// INSERT naredba takodje zahteva postavljanje odgovarajuceg katanca.
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">obradi_cekanje</span><span class="p">();</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Insert into"</span><span class="p">);</span>
        
        <span class="c1">// Potvrdjivanje izmena u tekucoj transakciji
</span>        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Commit"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">predmeti</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Close predmeti"</span><span class="p">);</span>

    <span class="c1">// Vracamo istek vremena na podrazumevanu vrednost
</span>    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set current lock timeout null"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Kako se vrsi obrada greske 
// u slucaju da aplikacija nije dobila neki katanac?
// S obzirom da se problem visekorisnickog okruzenja moze desiti 
// u bilo kom trenutku tokom izvrsavanja transakcije...
</span><span class="kt">void</span> <span class="nf">obradi_cekanje</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// ... nakon prikaza odgovarajuce poruke korisniku...
</span>    <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije.</span><span class="se">\n</span><span class="s">"</span>
        <span class="s">"Sacekati neko vreme.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// ... neophodno je izvrsiti ponistavanje izmena u tekucoj transakciji.
</span>    <span class="c1">// Da li mozete da konstruisete primer izvrsavanja ovog programa,
</span>    <span class="c1">// tako da ukoliko se ovde ne navede ponistavanje izmene,
</span>    <span class="c1">// baza prelazi u nekonzistentno stanje?
</span>    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>

    <span class="c1">// Naredba ponistavanja izmena uvek zatvara sve kursore,
</span>    <span class="c1">// te da bi naredna iteracija `for` petlje u `main` funkciji bila uspesna,
</span>    <span class="c1">// moramo otvoriti kursor.
</span>    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">predmeti</span><span class="p">;</span>    
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Open predmeti - obrada cekanja"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="53-nivoi-izolovanosti">5.3 Nivoi izolovanosti</h2>

<p>U najosnovnijem slučaju, svaka transakcija je u potpunosti izolovana od svih drugih transakcija. Međutim, videli smo da ovakva, potpuna izolovanost, može brzo dovesti do problema poput mrtve petlje u konkurentnom sistemu izvršavanja. Zbog toga, da bi se povećala konkurentnost između aplikacionih procesa, DB2 SUBP definiše različite nivoe izolovanosti na kojima aplikacija može da se izvršava.</p>

<div style="border-left: 7px solid rgb(196, 41, 255); padding-left: 15px; background-color: rgba(192, 192, 192, 0.2);">
    <p><span style="font-weight: bold;">Definicija:</span> <span style="font-style: italic;">Nivo izolovanosti</span> (engl. <span style="font-style: italic;">isolation level</span>) koji se pridružuje aplikacionom procesu određuje stepen zaključavanja ili izolacije u kojem su podaci kojima taj proces pristupa, u odnosu na druge konkurentne procese. </p>
</div>

<p>Drugim rečima, nivo izolovanosti jednog aplikacionog procesa P specifikuje sledeće:</p>

<ul>
  <li>Stepen u kojem su redovi koji se čitaju ili ažuriraju od strane procesa P dostupni drugim konkurentnim aplikacionim procesima.</li>
  <li>Stepen u kojem ažuriranja od strane drugih konkurentnih aplikacionih procesa mogu da utiču na izvršavanje procesa P.</li>
</ul>

<p>DB2 definiše naredna četiri nivoa izolacije:</p>

<ul>
  <li>Ponovljeno čitanje</li>
  <li>Stabilno čitanje</li>
  <li>Stabilni kursor</li>
  <li>Nepotvrđeno čitanje</li>
</ul>

<h3 id="531-ponovljeno-čitanje">5.3.1 Ponovljeno čitanje</h3>

<p>U nivou izolacije <em>ponovljeno čitanje</em> (engl. <em>repeatable read</em>, skr. <em>RR</em>) nijedan podatak koji je pročitan od strane procesa P ne sme se menjati od strane drugih procesa sve do završetka obrade od strane procesa P (čime se obezbeđuje saglasnost podataka u slučaju ponovljenog čitanja, te otuda i naziv nivoa izolacije). Sa druge strane, nijedan red promenjen od strane drugog procesa ne može se čitati od strane procesa P dok se promene u okviru tog procesa na okončaju.</p>

<p>Osim već pomenutih ekskluzivnih katanaca, proces na RR nivou izolovanosti dobija bar deljive katance na svim podacima kojima pristupa, pri čemu se zaključavanje vrši tako da je proces u potpunosti izolovan od strane ostalih procesa.</p>

<h3 id="532-stabilno-čitanje">5.3.2 Stabilno čitanje</h3>

<p>U nivou izolacije <em>stabilno čitanje</em> (engl. <em>read stability</em>, skr. <em>RS</em>) nijedan podatak koji je pročitan od strane procesa P ne sme se menjati od strane drugih procesa sve do završetka obrade od strane procesa P. Sa druge strane, nijedan red promenjen od strane drugog procesa ne može se čitati dok se promene u okviru tog procesa ne okončaju.</p>

<p>Međutim, za razliku od RR, na ovom nivou izolacije proces koji izvršava isti upit više puta, može dobiti neke nove redove u odgovorima u slučaju da drugi proces unese nove redove koji zadovoljavaju dati upit i potvrdi te izmene. Ovo predstavlja tzv. <em>problem fantomskih redova</em> (engl. <em>fantom rows problem</em>).</p>

<p>Osim ekskluzivnih katanaca, proces na RS nivou izolovanosti dobija bar deljive katance na svim podacima koji su prihvaćeni. Na primer, neka se u procesu P izvršava naredni upit:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="err">∗</span>
<span class="k">FROM</span>    <span class="n">SMER</span>
<span class="k">WHERE</span>   <span class="n">ID_NIVOA</span> <span class="o">=</span> <span class="mi">10</span>
</code></pre></div></div>

<p>U slučaju RR nivoa izolovanosti izvršavanje ovog upita izazvaće zaključavanje svih redova tabele <code class="highlighter-rouge">SMER</code>, a u slučaju RS nivoa izolovanosti zaključavanje se vrši samo nad onim redovima koji ispunjavaju uslov restrikcije <code class="highlighter-rouge">ID_NIVOA = 10</code>. Zbog toga, ako neki drugi proces unese novi red koji zadovoljava datu restrikciju, u slučaju RR nivoa izolovanosti to neće biti moguće, dok će ponovo izvršavanje upita u slučaju RS nivoa izolovanosti proizvesti prikazivanje i tih novih redova.</p>

<h3 id="533-stabilni-kursor">5.3.3 Stabilni kursor</h3>

<p>U nivou izolacije <em>stabilni kursor</em> (engl. <em>cursor stability</em>, skr. <em>CS</em>) nijedan proces ne može da menja podatke iz reda dok je ažurirajući kursor pozicioniran nad tim redom. Dakle, ovaj nivo izolovanosti obezbeđuje da konkurentni procesi ne mogu menjati samo trenutno aktivne redove otvorenih kursora posmatranog procesa P. Redovi koji su ranije pročitani mogu biti menjani. Takodje, nijedan red promenjen od strane drugog procesa ne može se čitati dok se promene u okviru tog procesa na okončaju.</p>

<p>Takođe, ovaj nivo izolovanosti zaključava sve redove kojima transakcija pristupa dok je kursor pozicioniran na tim redovima. Ako transakcija koristi podatke iz reda za čitanje, onda se ovaj katanac drži sve dok se ne dohvati naredni red u kursoru ili dok se transakcija ne završi. Međutim, ako je izmena izvršena nad nekim redom, onda se nad tim redom drži katanac sve do kraja transakcije.</p>

<p>Očito, i u ovom nivou izolacije moguć je problem fantomskih redova. Međutim, postoji još jedan problem koji se može javiti. Neka prvo proces A pročita red, pa zatim pređe na druge redove. Neka zatim proces B pročita i izmeni isti red i potvrdi svoje izmene. Ukoliko proces A ponovo pročita isti red, videće drugačije vrednosti u odnosu na prethodno čitanje. Ovaj problem se naziva <em>problem neponovljivih čitanja</em> (engl. <em>non-repeatable reads problem</em>).</p>

<p>Bez obzira na razne ekskluzivne katance, ovaj nivo obezbeđuje bar deljive katance na aktivnim redovima svih kursora.</p>

<h3 id="534-nepotvrđeno-čitanje">5.3.4 Nepotvrđeno čitanje</h3>

<p>I nivou izolacije <em>nepotvrđeno čitanje</em> (engl. <em>uncommitted read</em>, skr. <em>UR</em>) proces P može da pristupi nepotvrđenim izmenama od strane drugih procesa. Dodatno, nivo izolacije UR ne sprečava drugim procesima da pristupe redu koji čita proces P, osim ukoliko taj drugi proces ne pokušava da izmeni strukturu tabele ili da je obriše.</p>

<p>Za naredbe <code class="highlighter-rouge">SELECT INTO</code> ili <code class="highlighter-rouge">FETCH</code> nad kursorom koji služi samo za čitanje, ili podupite naredbi <code class="highlighter-rouge">INSERT</code> ili <code class="highlighter-rouge">UPDATE</code>, ili upite koji kao rezultat imaju skalarnu vrednost, ovaj nivo izolacije omogućava da:</p>

<ul>
  <li>
    <p>Bilo koji red pročitan tokom jedinice obrade bude promenjen od strane drugih procesa.</p>
  </li>
  <li>
    <p>Proces može čitati podatke izmenjene od strane drugih korisnika, čak i pre nego što su te izmene potvrđene (ne traži se deljeni katanac za čitanje).</p>
  </li>
  <li>
    <p>Za ostale operacije važe pravila nivoa izolovanosti CS.</p>
  </li>
</ul>

<p>Pored problema fantomskih redova i problema neponovljivih čitanja, postoji još jedan problem koji se može javiti u ovom nivou izolacije. Ako prvo proces A izmeni neku vrednost, zatim proces B pročita tu vrednost pre nego što je potvrđena, a zatim proces A poništi svoje izmene, onda proces B može raditi nad nekorektnim podacima. Ovaj problem se naziva <em>problem pristupa nepotvrđenim podacima</em> (engl. <em>access to uncommitted data problem</em>).</p>

<h3 id="535-programersko-podešavanje-nivoa-izolovanosti">5.3.5 Programersko podešavanje nivoa izolovanosti</h3>

<p>Moguće je specifikovati koji se nivo izolovanosti koristi i on je u efektu tokom trajanja jedinice posla. Postoji nekoliko načina za podešavanje nivoa izolovanosti:</p>

<ul>
  <li>Navođenje na nivou jedne naredbe je moguće izvršiti korišćenjem klauze <code class="highlighter-rouge">WITH</code><sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>, čija je sintaksa data u nastavku:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="p">(</span>
    <span class="n">RR</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">KLAUZA_ZAKLJU</span><span class="err">Č</span><span class="n">AVANJA</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">|</span>
    <span class="n">RS</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">KLAUZA_ZAKLJU</span><span class="err">Č</span><span class="n">AVANJA</span><span class="o">&gt;</span><span class="p">]</span> <span class="o">|</span>
    <span class="n">CS</span> <span class="o">|</span>
    <span class="n">UR</span>
<span class="p">)</span>
</code></pre></div></div>

<p>gde je <code class="highlighter-rouge">&lt;KLAUZA_ZAKLJUČAVANJA&gt;</code> klauza kojom se specifikuje tip katanca koji aplikacija zahteva od SUBP, a čija je sintaksa:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="k">AND</span> <span class="n">KEEP</span> <span class="p">(</span><span class="k">SHARE</span><span class="o">|</span><span class="k">UPDATE</span><span class="o">|</span><span class="k">EXCLUSIVE</span><span class="p">)</span> <span class="n">LOCKS</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">WITH</code> klauza se može koristiti u narednim naredbama: <code class="highlighter-rouge">DECLARE CURSOR</code>, pretražujuća <code class="highlighter-rouge">UPDATE</code> naredba, <code class="highlighter-rouge">INSERT</code>, <code class="highlighter-rouge">SELECT</code>, <code class="highlighter-rouge">SELECT INTO</code> i pretražujuća <code class="highlighter-rouge">DELETE</code> naredba.</p>

<ul>
  <li>Podešavanjem specijalnog registra <code class="highlighter-rouge">CURRENT ISOLATION</code>, čiji je tip <code class="highlighter-rouge">CHAR(2)</code>, a koji sadrži informaciju o nivou izolacije za svaku dinamičku SQL naredbu koja se izvršava u tekućoj sesiji. Moguće vrednosti su: prazna niska, <code class="highlighter-rouge">'RR'</code>, <code class="highlighter-rouge">'RS'</code>, <code class="highlighter-rouge">'CS'</code> i <code class="highlighter-rouge">'UR'</code>. Promena ove vrednosti se može izvršiti naredbom <code class="highlighter-rouge">SET CURRENT ISOLATION</code>, čija je sintaksa:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SET</span> <span class="p">[</span><span class="k">CURRENT</span><span class="p">]</span> <span class="k">ISOLATION</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="p">(</span><span class="n">UR</span><span class="o">|</span><span class="n">CS</span><span class="o">|</span><span class="n">RR</span><span class="o">|</span><span class="n">RS</span><span class="o">|</span><span class="k">RESET</span><span class="p">)</span>
</code></pre></div></div>

<p>Navođenjem vrednosti <code class="highlighter-rouge">RESET</code> će vrednost registra biti postavljena na praznu nisku, što znači da se neće koristiti ta vrednost za registar.</p>

<ul>
  <li>Navođenjem vrednosti za nivo izolacije kao atribut paketa, čime se efektivno koristi ta vrednost za aplikacije koje koriste taj paket. Ovo se može uraditi navođenjem <code class="highlighter-rouge">ISOLATION</code> opcije prilikom izvršavanja naredbi <code class="highlighter-rouge">PRECOMPILE</code> ili <code class="highlighter-rouge">BIND</code>. Ova opcija ima narednu sintaksu:</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ISOLATION</span> <span class="p">(</span><span class="n">CS</span><span class="o">|</span><span class="n">RR</span><span class="o">|</span><span class="n">RS</span><span class="o">|</span><span class="n">UR</span><span class="p">)</span>
</code></pre></div></div>

<p>Ukoliko se ne specifikuje nivo izolacije, DB2 će podrazumevano koristiti nivo CS.</p>

<p>Naredni primeri ilustruju različite efekte iste aplikacije pri različitim nivoima izolovanosti. Primetimo da smo u narednim primerima koristili klauzu <code class="highlighter-rouge">WITH</code> za postavljanje nivoa izolovanosti.</p>

<div style="border: 2px solid rgb(196, 41, 255); padding: 5px; background-color: rgba(197, 197, 197, 0.3); margin: 10px 0;">
    <p style="font-weight: bold;">Zadatak 5.2</p>
    Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">repeatableRead</span> koji dva puta ispisuje informacije o godini, oznaci, nazivu i periodu prijavljivanja za svaki ispitni rok u 2016. godini. Omogućiti da se prilikom oba ispisivanja dobijaju iste informacije.<br />
<br />
Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">insertIspitniRok</span> koji unosi novi ispitni rok za mesec mart u 2016. godini. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.
</div>

<p>Rešenje: Pre početka izvršavanja bilo kog programa, pokrenuti skript <code class="highlighter-rouge">pripremaBaze</code> čiji je sadržaj:</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_2/pripremaBaze</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span><span class="c">#/bin/bash </span>

db2 connect to vstud user student using abcdef
db2 <span class="nt">-t</span> <span class="nt">-f</span> pripremaBaze.sql
db2 connect reset
</code></pre></div></div>

<p>a koji će uneti neke informacije o ispitnim rokovima u bazu podataka na osnovu skripta <code class="highlighter-rouge">pripremaBaze.sql</code> čiji je sadržaj:</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_2/pripremaBaze.sql</code>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> 
<span class="k">FROM</span>    <span class="n">ISPITNI_ROK</span>
<span class="k">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span><span class="p">;</span>

<span class="k">INSERT</span> 
<span class="k">INTO</span>    <span class="n">ISPITNI_ROK</span> 
<span class="k">VALUES</span>  <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="s1">'Jan2016'</span><span class="p">,</span> <span class="s1">'Januar 2016'</span><span class="p">,</span> <span class="s1">'01/01/2016'</span><span class="p">,</span> <span class="s1">'01/12/2016'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="s1">'Feb2016'</span><span class="p">,</span> <span class="s1">'Februar 2016'</span><span class="p">,</span> <span class="s1">'02/01/2016'</span><span class="p">,</span> <span class="s1">'02/12/2016'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">);</span>
</code></pre></div></div>

<p>Pokrenuti program <code class="highlighter-rouge">repeatableRead</code> i započeti prvo ispisivanje. U toku ispisivanja ili nakon njega, pokrenuti program <code class="highlighter-rouge">insertIspitniRok</code>, pa nastaviti sa daljim ispisivanjem ispitnih rokova.</p>

<p>Uveriti se da program <code class="highlighter-rouge">insertIspitniRok</code> ne može da izvrši unos sve dok program <code class="highlighter-rouge">repeatableRead</code> ne završi sa svim ispisivanjima i takođe da oba ispisivanja imaju iste vrednosti.</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_2/repeatableRead.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">godina</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">oznaka</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">naziv</span><span class="p">[</span><span class="mi">51</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">ispitniRok</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">GODINA</span><span class="p">,</span> 
                <span class="n">OZNAKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span>
        <span class="n">FROM</span>    <span class="n">ISPITNI_ROK</span>
        <span class="n">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span>
        <span class="n">WITH</span>    <span class="n">RR</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Citanje rezultata %d. put. "</span>
            <span class="s">"Pritisnite neki taster za pocetak.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">ispitniRok</span><span class="p">;</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>
        
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">FETCH</span>   <span class="n">ispitniRok</span> 
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">godina</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">oznaka</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">naziv</span><span class="p">;</span>
            <span class="n">is_error</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"Godina %d oznaka: %s i naziv %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">godina</span><span class="p">,</span> <span class="n">oznaka</span><span class="p">,</span> <span class="n">naziv</span><span class="p">);</span>
            
            <span class="n">printf</span><span class="p">(</span><span class="s">"Pritisnite neki taster za dalje citanje."</span><span class="p">);</span>
            <span class="n">getchar</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">ispitniRok</span><span class="p">;</span>    
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_2/insertIspitniRok.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">obradi_cekanje</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije. "</span>
        <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span> 
            <span class="n">INTO</span>    <span class="n">ISPITNI_ROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="err">'</span><span class="n">mar</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">Mart</span> <span class="mi">2016</span><span class="err">'</span><span class="p">,</span> <span class="n">CURRENT_DATE</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">MONTH</span><span class="p">,</span> <span class="n">CURRENT_DATE</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">MONTH</span> <span class="o">+</span> <span class="mi">20</span> <span class="n">DAYS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">obradi_cekanje</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div style="border: 2px solid rgb(196, 41, 255); padding: 5px; background-color: rgba(197, 197, 197, 0.3); margin: 10px 0;">
    <p style="font-weight: bold;">Zadatak 5.3</p>
    Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">readStability</span> koji dva puta ispisuje informacije o godini, oznaci, nazivu i periodu prijavljivanja za svaki ispitni rok u 2016. godini. Dozvoljeno je da se prilikom drugog ispisivanja pojave novi redovi, ali ne i da budu vidljive izmene pročitanih redova. <br />
<br />
Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">insertIspitniRok</span> koji unosi novi ispitni rok za mesec mart u 2016. godini. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.<br />
<br />
Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">updateIspitniRok</span> koji za svaki ispitni rok u 2016. godini produžava period prijavljivanja za 3 dana. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.
</div>

<p>Rešenje: Pre početka izvršavanja bilo kog programa, pokrenuti skript <code class="highlighter-rouge">pripremaBaze</code> čiji je sadržaj:</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_3/pripremaBaze</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span><span class="c">#/bin/bash </span>

db2 connect to vstud user student using abcdef
db2 <span class="nt">-t</span> <span class="nt">-f</span> pripremaBaze.sql
db2 connect reset
</code></pre></div></div>

<p>a koji će uneti neke informacije o ispitnim rokovima u bazu podataka na osnovu skripta <code class="highlighter-rouge">pripremaBaze.sql</code> čiji je sadržaj:</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_3/pripremaBaze.sql</code>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> 
<span class="k">FROM</span>    <span class="n">ISPITNI_ROK</span>
<span class="k">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span><span class="p">;</span>

<span class="k">INSERT</span> 
<span class="k">INTO</span>    <span class="n">ISPITNI_ROK</span> 
<span class="k">VALUES</span>  <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="s1">'Jan2016'</span><span class="p">,</span> <span class="s1">'Januar 2016'</span><span class="p">,</span> <span class="s1">'01/01/2016'</span><span class="p">,</span> <span class="s1">'01/12/2016'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="s1">'Feb2016'</span><span class="p">,</span> <span class="s1">'Februar 2016'</span><span class="p">,</span> <span class="s1">'02/01/2016'</span><span class="p">,</span> <span class="s1">'02/12/2016'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">);</span>
</code></pre></div></div>

<p>Pokrenuti program <code class="highlighter-rouge">readStability</code> i započeti prvo ispisivanje. U toku ispisivanja ili nakon njega, pokrenuti programe <code class="highlighter-rouge">insertIspitniRok</code> i <code class="highlighter-rouge">updateIspitniRok</code>, pa nastaviti sa daljim ispisivanjem ispitnih rokova.</p>

<p>Uveriti se da program <code class="highlighter-rouge">insertIspitniRok</code> može da izvrši unos novog ispitnog roka tokom rada programa <code class="highlighter-rouge">readStability</code> i da se novi rok vidi prilikom drugog ispisivanja.</p>

<p>Takođe, uveriti se i da program <code class="highlighter-rouge">updateIspitniRok</code> ne može da promeni informacije o ispitnim rokovima sve dok program <code class="highlighter-rouge">readStability</code> ne završi sa izvršavanjem.</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_3/readStability.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">godina</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">oznaka</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">naziv</span><span class="p">[</span><span class="mi">51</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">ispitniRok</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">GODINA</span><span class="p">,</span> 
                <span class="n">OZNAKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span>
        <span class="n">FROM</span>    <span class="n">ISPITNI_ROK</span>
        <span class="n">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span>
        <span class="n">WITH</span>    <span class="n">RS</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Citanje rezultata %d. put. "</span>
            <span class="s">"Pritisnite neki taster za pocetak.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">ispitniRok</span><span class="p">;</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>
        
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">FETCH</span>   <span class="n">ispitniRok</span> 
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">godina</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">oznaka</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">naziv</span><span class="p">;</span>
            <span class="n">is_error</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"Godina %d oznaka: %s i naziv %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">godina</span><span class="p">,</span> <span class="n">oznaka</span><span class="p">,</span> <span class="n">naziv</span><span class="p">);</span>
            
            <span class="n">printf</span><span class="p">(</span><span class="s">"Pritisnite neki taster za dalje citanje."</span><span class="p">);</span>
            <span class="n">getchar</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">ispitniRok</span><span class="p">;</span>    
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_3/insertIspitniRok.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">obradi_cekanje</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije. "</span>
        <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span> 
            <span class="n">INTO</span>    <span class="n">ISPITNI_ROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="err">'</span><span class="n">mar</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">Mart</span> <span class="mi">2016</span><span class="err">'</span><span class="p">,</span> <span class="n">CURRENT_DATE</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">MONTH</span><span class="p">,</span> <span class="n">CURRENT_DATE</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">MONTH</span> <span class="o">+</span> <span class="mi">20</span> <span class="n">DAYS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">obradi_cekanje</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_3/updateIspitniRok.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">obradi_cekanje</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije. "</span>
        <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">UPDATE</span>  <span class="n">ISPITNI_ROK</span>
            <span class="n">SET</span>     <span class="n">KRAJ_PRIJAVLJIVANJA</span> <span class="o">=</span> <span class="n">KRAJ_PRIJAVLJIVANJA</span> <span class="o">+</span> <span class="mi">3</span> <span class="n">DAYS</span>
            <span class="n">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span><span class="p">;</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">obradi_cekanje</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">is_error</span><span class="p">(</span><span class="s">"UPDATE"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div style="border: 2px solid rgb(196, 41, 255); padding: 5px; background-color: rgba(197, 197, 197, 0.3); margin: 10px 0;">
    <p style="font-weight: bold;">Zadatak 5.4</p>
    Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">cursorStability</span> koji dva puta ispisuje informacije o godini, oznaci, nazivu i periodu prijavljivanja za svaki ispitni rok u 2016. godini. Dozvoljeno je da se prilikom drugog ispisivanja pojave novi redovi, kao i da budu vidljive izmene pročitanih redova.<br />
<br />
Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">insertIspitniRok</span> koji unosi novi ispitni rok za mesec mart u 2016. godini. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.<br />
<br />
Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">updateIspitniRok</span> koji za svaki ispitni rok u 2016. godini produžava period prijavljivanja za 3 dana. Postaviti istek vremena za zahtevanje katanaca na 5 sekundi.
</div>

<p>Rešenje: Pre početka izvršavanja bilo kog programa, pokrenuti skript <code class="highlighter-rouge">pripremaBaze</code> čiji je sadržaj:</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_4/pripremaBaze</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">!</span><span class="c">#/bin/bash </span>

db2 connect to vstud user student using abcdef
db2 <span class="nt">-t</span> <span class="nt">-f</span> pripremaBaze.sql
db2 connect reset
</code></pre></div></div>

<p>a koji će uneti neke informacije o ispitnim rokovima u bazu podataka na osnovu skripta <code class="highlighter-rouge">pripremaBaze.sql</code> čiji je sadržaj:</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_4/pripremaBaze.sql</code>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DELETE</span> 
<span class="k">FROM</span>    <span class="n">ISPITNI_ROK</span>
<span class="k">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span><span class="p">;</span>

<span class="k">INSERT</span> 
<span class="k">INTO</span>    <span class="n">ISPITNI_ROK</span> 
<span class="k">VALUES</span>  <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="s1">'Jan2016'</span><span class="p">,</span> <span class="s1">'Januar 2016'</span><span class="p">,</span> <span class="s1">'01/01/2016'</span><span class="p">,</span> <span class="s1">'01/12/2016'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="s1">'Feb2016'</span><span class="p">,</span> <span class="s1">'Februar 2016'</span><span class="p">,</span> <span class="s1">'02/01/2016'</span><span class="p">,</span> <span class="s1">'02/12/2016'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">);</span>
</code></pre></div></div>

<p>Pokrenuti program <code class="highlighter-rouge">cursorStability</code> i započeti prvo ispisivanje. U toku ispisivanja ili nakon njega, pokrenuti programe <code class="highlighter-rouge">insertIspitniRok</code> i <code class="highlighter-rouge">updateIspitniRok</code>, pa nastaviti sa daljim ispisivanjem ispitnih rokova.</p>

<p>Uveriti se da program <code class="highlighter-rouge">insertIspitniRok</code> može da izvrši unos novog ispitnog roka tokom rada programa <code class="highlighter-rouge">cursorStability</code> i da se novi rok vidi prilikom drugog ispisivanja.</p>

<p>Takođe, uveriti se i da program <code class="highlighter-rouge">updateIspitniRok</code> može da promeni informacije o ispitnim rokovima i da se izmene vide u programu <code class="highlighter-rouge">cursorStability</code> tokom drugog ispisivanja.</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_4/cursorStability.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">godina</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">oznaka</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> 
     <span class="n">naziv</span><span class="p">[</span><span class="mi">51</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">pocetak</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> 
     <span class="n">kraj</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">ispitniRok</span> <span class="n">CURSOR</span> <span class="n">FOR</span>
        <span class="n">SELECT</span>  <span class="n">GODINA</span><span class="p">,</span> 
                <span class="n">OZNAKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span> 
                <span class="n">POCETAK_PRIJAVLJIVANJA</span><span class="p">,</span> 
                <span class="n">KRAJ_PRIJAVLJIVANJA</span>
        <span class="n">FROM</span>    <span class="n">ISPITNI_ROK</span>
        <span class="n">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span>
        <span class="n">WITH</span>    <span class="n">CS</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Citanje rezultata %d. put. "</span>
            <span class="s">"Pritisnite neki taster za pocetak.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">ispitniRok</span><span class="p">;</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Open"</span><span class="p">);</span>
        
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">EXEC</span> <span class="n">SQL</span> 
                <span class="n">FETCH</span>   <span class="n">ispitniRok</span> 
                <span class="n">INTO</span>    <span class="o">:</span><span class="n">godina</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">oznaka</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">naziv</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">pocetak</span><span class="p">,</span> 
                        <span class="o">:</span><span class="n">kraj</span><span class="p">;</span>
            <span class="n">is_error</span><span class="p">(</span><span class="s">"Fetch"</span><span class="p">);</span>

            <span class="k">if</span><span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Godina %d oznaka: %s i naziv %s</span><span class="se">\n</span><span class="s">"</span>
                <span class="s">"Prijavljivanje: %s - %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">godina</span><span class="p">,</span> <span class="n">oznaka</span><span class="p">,</span> <span class="n">naziv</span><span class="p">,</span> <span class="n">pocetak</span><span class="p">,</span> <span class="n">kraj</span><span class="p">);</span>
            
            <span class="n">printf</span><span class="p">(</span><span class="s">"Pritisnite neki taster za dalje citanje."</span><span class="p">);</span>
            <span class="n">getchar</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">ispitniRok</span><span class="p">;</span>    
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Close"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_4/insertIspitniRok.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">obradi_cekanje</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije. "</span>
        <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">INSERT</span> 
            <span class="n">INTO</span>    <span class="n">ISPITNI_ROK</span>
            <span class="n">VALUES</span>  <span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="err">'</span><span class="n">mar</span><span class="err">'</span><span class="p">,</span> <span class="err">'</span><span class="n">Mart</span> <span class="mi">2016</span><span class="err">'</span><span class="p">,</span> <span class="n">CURRENT_DATE</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">MONTH</span><span class="p">,</span> <span class="n">CURRENT_DATE</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">MONTH</span> <span class="o">+</span> <span class="mi">20</span> <span class="n">DAYS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">obradi_cekanje</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Insert"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_4/updateIspitniRok.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">obradi_cekanje</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Objekat je zakljucan od strane druge transakcije. "</span>
        <span class="s">"Sacekati neko vreme...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Rollback"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">UPDATE</span>  <span class="n">ISPITNI_ROK</span>
            <span class="n">SET</span>     <span class="n">KRAJ_PRIJAVLJIVANJA</span> <span class="o">=</span> <span class="n">KRAJ_PRIJAVLJIVANJA</span> <span class="o">+</span> <span class="mi">3</span> <span class="n">DAYS</span>
            <span class="n">WHERE</span>   <span class="n">GODINA</span> <span class="o">=</span> <span class="mi">2016</span><span class="p">;</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">911</span> <span class="o">||</span> <span class="n">SQLCODE</span> <span class="o">==</span> <span class="o">-</span><span class="mi">913</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">obradi_cekanje</span><span class="p">();</span>
        <span class="p">}</span>
        
        <span class="n">is_error</span><span class="p">(</span><span class="s">"UPDATE"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">SET</span> <span class="n">CURRENT</span> <span class="n">LOCK</span> <span class="n">TIMEOUT</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Set timeout"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="54-programersko-zaključavanje-tabela">5.4 Programersko zaključavanje tabela</h2>

<p>Programeri mogu sami da zatraže katance od SUBP ukoliko smatraju da im je to neophodno, ali sa ograničenjem da je na ovaj način jedino moguće zaključati tabelu, a ne redove, blokove, i druge objekte. SQL naredba <code class="highlighter-rouge">LOCK TABLE</code> onemogućava konkurentnoj aplikaciji da koristi ili menja tabelu, u zavinosti od režima u kojem se tabela zaključava. Ovako dobijeni katanac se oslobađa kada se završi jedinica posla u kojem je naredba <code class="highlighter-rouge">LOCK TABLE</code> izvršena, bilo operacijom potvrđivanja izmena ili njenim završavanjem.</p>

<p>Korisnik koji izvršava naredbu <code class="highlighter-rouge">LOCK TABLE</code> mora da ima barem jednu od narednih privilegija da bi je uspešno izvršio:</p>

<ul>
  <li><code class="highlighter-rouge">SELECT</code> privilegiju nad tabelom koja se zaključava.</li>
  <li><code class="highlighter-rouge">CONTROL</code> privilegiju nad tabelom koja se zaključava.</li>
  <li><code class="highlighter-rouge">DATAACCESS</code> privilegiju.</li>
</ul>

<p>Sintaksa ove naredbe je data u nastavku:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">LOCK</span> <span class="k">TABLE</span> <span class="o">&lt;</span><span class="n">IME_TABELE</span><span class="o">&gt;</span> <span class="k">IN</span> <span class="p">[</span><span class="k">SHARE</span><span class="o">|</span><span class="k">EXCLUSIVE</span><span class="p">]</span> <span class="k">MODE</span>
</code></pre></div></div>

<p>Ovom naredbom se traži odgovarajući katanac nad tabelom <code class="highlighter-rouge">&lt;IME_TABELE&gt;</code>. U zavisnosti od odabranih vrednosti narednih opcija prilikom deklaracije složene SQL naredbe, ta naredba može imati različite varijante koji utiču na način izvršavanja:</p>

<ul>
  <li>
    <p>Klauza <code class="highlighter-rouge">SHARE</code> onemogućava konkurentnoj aplikaciji da izvrši bilo koju operaciju osim čitanja podataka iz tabele.</p>
  </li>
  <li>
    <p>Kluza <code class="highlighter-rouge">EXCLUSIVE</code> onemogućava konkurentnoj aplikaciji da izvrši bilo koju operaciju nad tabelom. Napomenimo da ovaj režim ne onemogućava da aplikacioni procesi izvršavaju naredbe čitanja podataka iz tabele ukoliko oni rade na nivou izolacije nepotvrđeno čitanje (UR).</p>
  </li>
</ul>

<div style="border: 2px solid rgb(196, 41, 255); padding: 5px; background-color: rgba(197, 197, 197, 0.3); margin: 10px 0;">
    <p style="font-weight: bold;">Zadatak 5.5</p>
    Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">shareMode</span> koji ispisuje identifikator, oznaku, naziv, broj semestara i bodove za svaki smer u bazi podataka. Omogućiti da ostale aplikacije ne mogu da menjaju ove podatke tokom ispisivanja podataka.<br />
<br />
Napisati C/SQL program <span style="color: #e83e8c; background-color: #eef; padding: 1px 5px; font-family: SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;">exclusiveMode</span> koji ispisuje identifikator, oznaku, naziv, broj semestara i bodove za svaki smer u bazi podataka. Omogućiti da ostale aplikacije ne mogu da menjaju ove podatke tokom ispisivanja podataka, kao ni da ih čitaju.
</div>

<p>Rešenje: Isprobati sve kombinacije redosleda izvršavanja programa <code class="highlighter-rouge">exclusiveMode</code> i <code class="highlighter-rouge">shareMode</code> i uveriti se da jedino kombinacija <code class="highlighter-rouge">(shareMode, shareMode)</code> može raditi konkurentno.</p>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_5/shareMode.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">d_id</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">d_oznaka</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">d_naziv</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">d_semestara</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">d_bodovi</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="c1">// Zakljucavamo tabelu SMER u deljenom rezimu
</span>    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">LOCK</span> <span class="n">TABLE</span> <span class="n">SMER</span> <span class="n">IN</span> <span class="n">SHARE</span> <span class="n">MODE</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Lock table"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">c_smer</span> <span class="n">CURSOR</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">ID_SMERA</span><span class="p">,</span> 
                <span class="n">OZNAKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span> 
                <span class="n">SEMESTARA</span><span class="p">,</span> 
                <span class="n">BODOVI</span> 
        <span class="n">FROM</span>    <span class="n">SMER</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">c_smer</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Open cursor"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">c_smer</span>
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">d_id</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_oznaka</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_naziv</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_semestara</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_bodovi</span><span class="p">;</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Fetch cursor"</span><span class="p">);</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"ID:%d   OZNAKA:%s   NAZIV:%.70s   SEMESTARA:%d   bodovi:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
            <span class="n">d_id</span><span class="p">,</span> <span class="n">d_oznaka</span><span class="p">,</span> <span class="n">d_naziv</span><span class="p">,</span> <span class="n">d_semestara</span><span class="p">,</span> <span class="n">d_bodovi</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Pritisnite neki taster za naredno citanje</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">c_smer</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Close cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Datoteka: <code class="highlighter-rouge">primeri/poglavlje_5/zadatak_5_5/exclusiveMode.sqc</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">INCLUDE</span> <span class="n">SQLCA</span><span class="p">;</span>

<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">BEGIN</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>
<span class="n">sqlint32</span> <span class="n">d_id</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">d_oznaka</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">d_naziv</span><span class="p">[</span><span class="mi">201</span><span class="p">];</span>
<span class="kt">short</span> <span class="n">d_semestara</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">d_bodovi</span><span class="p">;</span>
<span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">END</span> <span class="n">DECLARE</span> <span class="n">SECTION</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">is_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SQLCODE %d: %s</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="n">SQLCODE</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
        
        <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">ROLLBACK</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">TO</span> <span class="n">vstud</span> <span class="n">USER</span> <span class="n">student</span> <span class="n">USING</span> <span class="n">abcdef</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect"</span><span class="p">);</span>
    
    <span class="c1">// Zakljucavamo tabelu SMER u privatnom rezimu
</span>    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">LOCK</span> <span class="n">TABLE</span> <span class="n">SMER</span> <span class="n">IN</span> <span class="n">EXCLUSIVE</span> <span class="n">MODE</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Lock table"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> 
        <span class="n">DECLARE</span> <span class="n">c_smer</span> <span class="n">CURSOR</span> <span class="n">FOR</span> 
        <span class="n">SELECT</span>  <span class="n">ID_SMERA</span><span class="p">,</span> 
                <span class="n">OZNAKA</span><span class="p">,</span> 
                <span class="n">NAZIV</span><span class="p">,</span> 
                <span class="n">SEMESTARA</span><span class="p">,</span> 
                <span class="n">BODOVI</span> 
        <span class="n">FROM</span>    <span class="n">SMER</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Declare cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">OPEN</span> <span class="n">c_smer</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Open cursor"</span><span class="p">);</span>
    
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">EXEC</span> <span class="n">SQL</span> 
            <span class="n">FETCH</span>   <span class="n">c_smer</span>
            <span class="n">INTO</span>    <span class="o">:</span><span class="n">d_id</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_oznaka</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_naziv</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_semestara</span><span class="p">,</span> 
                    <span class="o">:</span><span class="n">d_bodovi</span><span class="p">;</span>
        <span class="n">is_error</span><span class="p">(</span><span class="s">"Fetch cursor"</span><span class="p">);</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="n">SQLCODE</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"ID:%d   OZNAKA:%s   NAZIV:%.70s   SEMESTARA:%d   bodovi:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> 
            <span class="n">d_id</span><span class="p">,</span> <span class="n">d_oznaka</span><span class="p">,</span> <span class="n">d_naziv</span><span class="p">,</span> <span class="n">d_semestara</span><span class="p">,</span> <span class="n">d_bodovi</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Pritisnite neki taster za naredno citanje</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">getchar</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CLOSE</span> <span class="n">c_smer</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Close cursor"</span><span class="p">);</span>
    
    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">COMMIT</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Potvrdjivanje izmena"</span><span class="p">);</span>

    <span class="n">EXEC</span> <span class="n">SQL</span> <span class="n">CONNECT</span> <span class="n">RESET</span><span class="p">;</span>
    <span class="n">is_error</span><span class="p">(</span><span class="s">"Connect reset"</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="55-zadaci-za-vežbu">5.5 Zadaci za vežbu</h2>

<p>TODO</p>

<hr />
<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Obratiti pažnju da se ne radi o <code class="highlighter-rouge">WITH</code> klauzi za kreiranje privremenih tabela u <code class="highlighter-rouge">SELECT</code> naredbi, već da se ova <code class="highlighter-rouge">WITH</code> klauza nekad naziva i <code class="highlighter-rouge">isolation-clause</code>. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

</article>

        </div>
    </main><footer class="site-footer h-card">
    <data class="u-url" href="/PDb2BP/"></data>

    <div class="wrapper">

        <div class="row">
            <h2 class="footer-heading">Programiranje Db2 baza podataka</h2>
        </div>

        <div class="footer-col-wrapper">
            <div class="row">
                <div class="col-6">
                    <ul class="contact-list">
                        <li class="p-name">Programiranje Db2 baza podataka</li><li><a class="u-email" href="mailto:nikola_ajzenhamer@math.rs">nikola_ajzenhamer@math.rs</a></li></ul>
                </div>
                <div class="col-6">
                    <p>Elektronska knjiga &quot;Programiranje Db2 baza podataka&quot; dostupna besplatno na adresi&nbsp;<a
                            href="/PDb2BP/">https://theikeofficial.github.io//PDb2BP/</a>.</p>
                </div>
            </div>
        </div>

    </div>

</footer><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

</html>